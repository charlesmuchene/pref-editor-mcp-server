name: Ready for Review

on:
  pull_request:
    types: [labeled]

jobs:
  notify-codeowners:
    if: contains(github.event.label.name, 'READY-FOR-REVIEW')
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get CODEOWNERS
        id: codeowners
        run: |
          # Extract usernames from CODEOWNERS file
          if [ -f .github/CODEOWNERS ]; then
            # Get all @username mentions from CODEOWNERS, remove duplicates
            OWNERS=$(grep -o '@[a-zA-Z0-9_-]*' .github/CODEOWNERS | sort -u | tr '\n' ' ')
            echo "OWNERS=$OWNERS" >> $GITHUB_OUTPUT
            echo "Found code owners: $OWNERS"
          else
            echo "OWNERS=" >> $GITHUB_OUTPUT
            echo "No CODEOWNERS file found"
          fi

      - name: Tag code owners
        if: steps.codeowners.outputs.OWNERS != ''
        uses: actions/github-script@v7
        with:
          script: |
            const owners = '${{ steps.codeowners.outputs.OWNERS }}';
            const prNumber = context.payload.pull_request.number;
            const prAuthor = context.payload.pull_request.user.login;
            
            // Don't tag the PR author
            const filteredOwners = owners.split(' ')
              .filter(owner => owner.trim() !== '' && owner !== `@${prAuthor}`)
              .join(' ');
            
            if (filteredOwners) {
              const comment = `ÔøΩ  **Ready for Review**
              
This PR has been marked as ready for review. Code owners have been notified.

${filteredOwners} - Please review this PR when you have a moment.

---
**PR Summary:**
- Title: ${{ github.event.pull_request.title }}
- Author: @${{ github.event.pull_request.user.login }}
- Branch: \`${{ github.event.pull_request.head.ref }}\`
- Commits: ${{ github.event.pull_request.commits }}
- Files changed: ${{ github.event.pull_request.changed_files }}

**Checks:**
- CI Status: ${{ github.event.pull_request.mergeable_state }}
- Conflicts: ${context.payload.pull_request.mergeable ? '‚úÖ No conflicts' : '‚ö†Ô∏è Has conflicts'}`;

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: comment
              });
              
              console.log(`Tagged code owners: ${filteredOwners}`);
            } else {
              console.log('No code owners to tag (PR author excluded)');
            }

      - name: Log activity
        run: |
          echo "‚úÖ READY-FOR-REVIEW label detected on PR #${{ github.event.pull_request.number }}"
          echo "üìß Code owners have been notified"
          echo "üîó PR: ${{ github.event.pull_request.html_url }}"