name: Ready for Review

on:
  pull_request:
    types: [labeled]

jobs:
  notify-codeowners:
    if: contains(github.event.label.name, 'READY-FOR-REVIEW')
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check CI status
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const prNumber = context.payload.pull_request.number;
            const headSha = context.payload.pull_request.head.sha;
            
            console.log(`Checking CI status for PR #${prNumber}, SHA: ${headSha}`);
            
            // Get all check runs for this commit
            const checkRuns = await github.rest.checks.listForRef({
              owner,
              repo,
              ref: headSha
            });
            
            // Get all status checks for this commit
            const statusChecks = await github.rest.repos.getCombinedStatusForRef({
              owner,
              repo,
              ref: headSha
            });
            
            console.log(`Found ${checkRuns.data.check_runs.length} check runs`);
            console.log(`Combined status: ${statusChecks.data.state}`);
            
            // Look for CI workflow specifically
            const ciCheckRuns = checkRuns.data.check_runs.filter(run => 
              run.name.includes('test') || run.name.includes('CI')
            );
            
            console.log(`CI-related check runs: ${ciCheckRuns.length}`);
            
            // Check if CI has completed and passed
            let ciPassed = false;
            let ciCompleted = false;
            
            if (ciCheckRuns.length > 0) {
              // Check if all CI runs are completed
              ciCompleted = ciCheckRuns.every(run => run.status === 'completed');
              // Check if all completed CI runs passed
              ciPassed = ciCheckRuns.every(run => 
                run.status === 'completed' && run.conclusion === 'success'
              );
              
              console.log(`CI completed: ${ciCompleted}, CI passed: ${ciPassed}`);
              
              // Log details of each CI run
              ciCheckRuns.forEach(run => {
                console.log(`- ${run.name}: ${run.status} (${run.conclusion})`);
              });
            } else {
              // If no specific CI runs found, check overall status
              ciCompleted = statusChecks.data.state !== 'pending';
              ciPassed = statusChecks.data.state === 'success';
              console.log(`No CI-specific runs found, using combined status: ${statusChecks.data.state}`);
            }
            
            if (!ciCompleted) {
              core.setFailed('‚ùå CI checks are still running. Please wait for CI to complete before marking as ready for review.');
              return;
            }
            
            if (!ciPassed) {
              core.setFailed('‚ùå CI checks have failed. Please fix the issues before marking as ready for review.');
              return;
            }
            
            console.log('‚úÖ All CI checks have passed');

      - name: Get CODEOWNERS
        id: codeowners
        run: |
          # Extract usernames from CODEOWNERS file
          if [ -f .github/CODEOWNERS ]; then
            # Get all @username mentions from CODEOWNERS, remove duplicates
            OWNERS=$(grep -o '@[a-zA-Z0-9_-]*' .github/CODEOWNERS | sort -u | tr '\n' ' ')
            echo "OWNERS=$OWNERS" >> $GITHUB_OUTPUT
            echo "Found code owners: $OWNERS"
          else
            echo "OWNERS=" >> $GITHUB_OUTPUT
            echo "No CODEOWNERS file found"
          fi

      - name: Tag code owners
        if: steps.codeowners.outputs.OWNERS != ''
        uses: actions/github-script@v7
        with:
          script: |
            const owners = '${{ steps.codeowners.outputs.OWNERS }}';
            const prNumber = context.payload.pull_request.number;
            const prAuthor = context.payload.pull_request.user.login;
            
            // Don't tag the PR author
            const filteredOwners = owners.split(' ')
              .filter(owner => owner.trim() !== '' && owner !== `@${prAuthor}`)
              .join(' ');
            
            if (filteredOwners) {
              const comment = `ÔøΩ  **Ready for Review**
              
This PR has been marked as ready for review. Code owners have been notified.

${filteredOwners} - Please review this PR when you have a moment.

---
**PR Summary:**
- Title: ${{ github.event.pull_request.title }}
- Author: @${{ github.event.pull_request.user.login }}
- Branch: \`${{ github.event.pull_request.head.ref }}\`
- Commits: ${{ github.event.pull_request.commits }}
- Files changed: ${{ github.event.pull_request.changed_files }}

**Checks:**
- CI Status: ${{ github.event.pull_request.mergeable_state }}
- Conflicts: ${context.payload.pull_request.mergeable ? '‚úÖ No conflicts' : '‚ö†Ô∏è Has conflicts'}`;

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: comment
              });
              
              console.log(`Tagged code owners: ${filteredOwners}`);
            } else {
              console.log('No code owners to tag (PR author excluded)');
            }

      - name: Log activity
        run: |
          echo "‚úÖ READY-FOR-REVIEW label detected on PR #${{ github.event.pull_request.number }}"
          echo "üìß Code owners have been notified"
          echo "üîó PR: ${{ github.event.pull_request.html_url }}"